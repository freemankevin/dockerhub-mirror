# https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions
name: Mirror Docker Images

env:
  GITHUB_OWNER: freemankevin
  GHCR_REGISTRY: ghcr.io
  IMAGES_MANIFEST: images-manifest.yml

on:
  schedule:
    - cron: '30 1 * * *'
  push:
    branches-ignore:
      - 'dependabot/**'
    tags-ignore:
      - '**'
    paths:
      - 'images-manifest.yml'
      - '.github/workflows/mirror-images.yml'
  pull_request:
    paths:
      - 'images-manifest.yml'
      - '.github/workflows/mirror-images.yml'
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  mirror-docker-images:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    permissions:
      packages: write
      contents: write

    concurrency:
      group: ${{ github.workflow }}
      cancel-in-progress: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip jq
          pip3 install pyyaml requests

      - name: Install regclient
        uses: iarekylew00t/regctl-installer@v4

      - name: Login to docker.io
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Login to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GHCR_REGISTRY }}
          username: ${{ env.GITHUB_OWNER }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch latest versions and mirror images
        id: mirror
        run: |
          set -euo pipefail
          
          python3 << 'PYTHON_SCRIPT'
          import yaml
          import json
          import subprocess
          import sys
          import re
          from datetime import datetime
          import requests
          from pathlib import Path

          def get_latest_tag(image_name):
              """ä»Ž Docker Hub èŽ·å–æœ€æ–°çš„æ ‡ç­¾ç‰ˆæœ¬"""
              try:
                  # è§£æžé•œåƒå
                  parts = image_name.split('/')
                  if len(parts) == 2:
                      namespace, repo = parts
                  elif len(parts) == 1:
                      namespace = 'library'
                      repo = parts[0]
                  else:
                      return None
                  
                  # ç§»é™¤æ ‡ç­¾
                  repo = repo.split(':')[0]
                  
                  # è°ƒç”¨ Docker Hub API
                  url = f"https://hub.docker.com/v2/repositories/{namespace}/{repo}/tags"
                  params = {'page_size': 100, 'ordering': 'last_updated'}
                  
                  response = requests.get(url, params=params, timeout=10)
                  if response.status_code != 200:
                      print(f"âš ï¸  Failed to fetch tags for {namespace}/{repo}", file=sys.stderr)
                      return None
                  
                  data = response.json()
                  results = data.get('results', [])
                  
                  if not results:
                      return None
                  
                  # æŸ¥æ‰¾ latest å’Œè¯­ä¹‰åŒ–ç‰ˆæœ¬
                  latest_tag = None
                  semver_tags = []
                  
                  for tag in results:
                      tag_name = tag['name']
                      
                      # æ£€æŸ¥æ˜¯å¦æ˜¯è¯­ä¹‰åŒ–ç‰ˆæœ¬
                      if re.match(r'^\d+\.\d+\.\d+', tag_name):
                          semver_tags.append(tag_name)
                      
                      # æŸ¥æ‰¾ latest
                      if tag_name == 'latest':
                          latest_tag = tag_name
                  
                  # è¿”å›žè¯­ä¹‰åŒ–ç‰ˆæœ¬æˆ– latest
                  if semver_tags:
                      return semver_tags[0]
                  elif latest_tag:
                      return latest_tag
                  else:
                      return results[0]['name']
                  
              except Exception as e:
                  print(f"âŒ Error fetching tags for {image_name}: {str(e)}", file=sys.stderr)
                  return None

          def mirror_image(source, target):
              """é•œåƒåŒæ­¥"""
              try:
                  cmd = [
                      'regctl', 'image', 'copy',
                      '--verbosity', 'info',
                      '--digest-tags',
                      '--include-external',
                      '--referrers',
                      source, target
                  ]
                  result = subprocess.run(cmd, capture_output=True, text=True)
                  return result.returncode == 0
              except Exception as e:
                  print(f"âŒ Mirror failed: {str(e)}", file=sys.stderr)
                  return False

          # è¯»å–æ¸…å•
          with open('images-manifest.yml', 'r') as f:
              manifest = yaml.safe_load(f)

          registry = "${{ env.GHCR_REGISTRY }}"
          owner = "${{ env.GITHUB_OWNER }}"
          
          mirrored_images = []
          success_count = 0
          fail_count = 0

          for img in manifest.get('images', []):
              if not img.get('enabled', True):
                  continue
              
              source = img['source']
              description = img.get('description', '')
              
              # æå–é•œåƒåå’Œå½“å‰æ ‡ç­¾
              image_name = source.split(':')[0]
              current_tag = source.split(':')[1] if ':' in source else 'latest'
              
              print(f"ðŸ” Processing {image_name}...")
              
              # èŽ·å–æœ€æ–°ç‰ˆæœ¬
              latest_tag = get_latest_tag(image_name)
              if not latest_tag:
                  print(f"âš ï¸  Could not determine latest version for {image_name}, using {current_tag}")
                  latest_tag = current_tag
              
              source_image = f"{image_name}:{latest_tag}"
              
              # æž„å»ºç›®æ ‡é•œåƒ
              repo_name = image_name.replace('/', '__')
              target_image = f"{registry}/{owner}/{repo_name}:{latest_tag}"
              
              print(f"ðŸ“¦ Source: {source_image}")
              print(f"ðŸŽ¯ Target: {target_image}")
              
              # æ‰§è¡Œé•œåƒåŒæ­¥
              if mirror_image(source_image, target_image):
                  print(f"âœ… Successfully mirrored {source_image}")
                  mirrored_images.append({
                      'name': image_name,
                      'source': source_image,
                      'target': target_image,
                      'version': latest_tag,
                      'description': description,
                      'repository': repo_name,
                      'synced_at': datetime.utcnow().isoformat() + 'Z'
                  })
                  success_count += 1
              else:
                  print(f"âŒ Failed to mirror {source_image}")
                  fail_count += 1

          # ç”Ÿæˆé•œåƒæ¸…å• JSON
          output_data = {
              'updated_at': datetime.utcnow().isoformat() + 'Z',
              'registry': registry,
              'owner': owner,
              'total_count': len(mirrored_images),
              'success_count': success_count,
              'fail_count': fail_count,
              'images': mirrored_images
          }

          # ç¡®ä¿ç›®å½•å­˜åœ¨
          Path('web/public').mkdir(parents=True, exist_ok=True)
          
          # å†™å…¥ JSON æ–‡ä»¶
          with open('web/public/images.json', 'w') as f:
              json.dump(output_data, f, indent=2, ensure_ascii=False)

          print(f"\nðŸ“Š Summary:")
          print(f"   Total: {len(mirrored_images)}")
          print(f"   Success: {success_count}")
          print(f"   Failed: {fail_count}")
          print(f"âœ… Generated images.json")
          
          # è®¾ç½®è¾“å‡º
          print(f"::set-output name=success_count::{success_count}")
          print(f"::set-output name=fail_count::{fail_count}")
          PYTHON_SCRIPT

      - name: Commit and push changes
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add web/public/images.json
          
          if git diff --staged --quiet; then
            echo "ðŸ“ No changes to commit"
          else
            git commit -m "chore: update images manifest [skip ci]"
            git push
            echo "âœ… Changes committed and pushed"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ðŸŽ‰ Mirror Sync Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ• Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Success: ${{ steps.mirror.outputs.success_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ Failed: ${{ steps.mirror.outputs.fail_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— Registry: ${{ env.GHCR_REGISTRY }}/${{ env.GITHUB_OWNER }}" >> $GITHUB_STEP_SUMMARY