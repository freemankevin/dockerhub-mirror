# https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions
name: Mirror Docker Images

env:
  # GitHub ç”¨æˆ·å/ç»„ç»‡å
  GITHUB_OWNER: freemankevin
  # GHCR ä»“åº“å‰ç¼€
  GHCR_REGISTRY: ghcr.io
  # é•œåƒæ¸…å•æ–‡ä»¶è·¯å¾„
  IMAGES_MANIFEST: images-manifest.yml

on:
  schedule:
    - cron: '30 1 * * *'  # æ¯å¤© UTC 01:30 è¿è¡Œ
  push:
    branches-ignore:
      - 'dependabot/**'
    tags-ignore:
      - '**'
    paths:
      - 'images-manifest.yml'
      - '.github/workflows/mirror-images.yml'
  pull_request:
    paths:
      - 'images-manifest.yml'
      - '.github/workflows/mirror-images.yml'
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  mirror-docker-images:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      packages: write
      contents: read

    concurrency:
      group: ${{ github.workflow }}
      cancel-in-progress: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJSON(github) }}
        run: |
          echo "=== GitHub Context ==="
          printf '%s' "$GITHUB_CONTEXT" | python -m json.tool

      - name: Show environment variables
        run: |
          echo "=== Environment Variables ==="
          env | sort | grep -E "(GITHUB_|GHCR_|OWNER)" || true

      - name: Install regclient
        uses: iarekylew00t/regctl-installer@v4

      - name: Show regclient version
        run: regctl version

      - name: Login to docker.io
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Login to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GHCR_REGISTRY }}
          username: ${{ env.GITHUB_OWNER }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Docker Hub rate-limit
        run: |
          set -euo pipefail
          echo "ğŸ” Querying Docker Hub rate-limit..."

          token=$(curl -s -u "${{ secrets.DOCKER_HUB_USERNAME }}:${{ secrets.DOCKER_HUB_TOKEN }}" \
            "https://auth.docker.io/token?service=registry.docker.io&scope=repository:library/alpine:pull" |
            jq -r '.token')

          headers=$(curl -sI -H "Authorization: Bearer $token" \
            -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
            https://registry-1.docker.io/v2/library/alpine/manifests/latest)

          remain=$(echo "$headers" | awk -F'[ ;]' '/ratelimit-remaining/ {print $2}')
          limit=$(echo  "$headers" | awk -F'[ ;]' '/ratelimit-limit/      {print $2}')

          echo "ğŸ“Š Docker Hub pulls remaining: $remain / $limit"

      - name: Parse images manifest
        id: parse_images
        run: |
          set -euo pipefail

          if [[ ! -f "${{ env.IMAGES_MANIFEST }}" ]]; then
            echo "âŒ Manifest file not found: ${{ env.IMAGES_MANIFEST }}"
            exit 1
          fi

          # ä½¿ç”¨ yq æˆ– python è§£æ YAMLï¼Œæå–é•œåƒåˆ—è¡¨
          images=$(python3 << 'EOF'
          import yaml
          import sys

          with open('${{ env.IMAGES_MANIFEST }}', 'r') as f:
              data = yaml.safe_load(f)

          if data and 'images' in data:
              for img in data['images']:
                  if img.get('enabled', True):  # é»˜è®¤å¯ç”¨
                      print(img['source'])
          else:
              print("Warning: No images found in manifest", file=sys.stderr)
          EOF
          )

          echo "images<<EOF" >> "$GITHUB_OUTPUT"
          echo "$images" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          echo "ğŸ“‹ Parsed images from manifest"

      - name: Mirror images
        id: mirror_images
        run: |
          set -eu

          repos=()
          images="${{ steps.parse_images.outputs.images }}"

          if [[ -z "$images" ]]; then
            echo "âš ï¸ No images to mirror"
            exit 0
          fi

          while IFS= read -r image; do
            image=$(echo "$image" | xargs)
            [[ -n "$image" ]] || continue

            echo "::group::ğŸ”„ Mirroring [$image]..."

            name="${image%%:*}"
            tag="${image#*:}"
            repo="${name//\//__}"

            target_image="${{ env.GHCR_REGISTRY }}/${{ env.GITHUB_OWNER }}/$repo:$tag"

            echo "Source: $image"
            echo "Target: $target_image"

            if regctl image copy \
              --verbosity debug \
              --digest-tags \
              --include-external \
              --referrers \
              "$image" \
              "$target_image"; then
              echo "âœ… Successfully mirrored: $repo:$tag"
              repos+=("$repo")
            else
              echo "âŒ Failed to mirror: $image"
            fi

            echo "::endgroup::"
          done <<< "$images"

          if [[ ${#repos[@]} -gt 0 ]]; then
            packages=$(printf '%s\n' "${repos[@]}" | sort -u | paste -sd ',')
            echo "packages=${packages}" >> "$GITHUB_OUTPUT"
            echo "âœ… Mirrored ${#repos[@]} package(s)"
          else
            echo "âš ï¸ No packages were successfully mirrored"
          fi

      - name: Make images public (optional)
        if: success() && steps.mirror_images.outputs.packages
        run: |
          set -euo pipefail

          packages="${{ steps.mirror_images.outputs.packages }}"
          IFS=',' read -ra pkg_array <<< "$packages"

          for pkg in "${pkg_array[@]}"; do
            echo "ğŸ“¦ Processing package: $pkg"
            # å¯é€‰ï¼šé€šè¿‡ GitHub API è®¾ç½®åŒ…å¯è§æ€§
            # curl -X PATCH \
            #   -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            #   -H "Accept: application/vnd.github.v3+json" \
            #   https://api.github.com/user/packages/container/$pkg \
            #   -d '{"visibility":"public"}'
          done

      - name: Update mirror index (optional)
        if: success()
        run: |
          set -euo pipefail

          echo "ğŸ“ Mirror sync completed at $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ¯ Owner: ${{ env.GITHUB_OWNER }}"
          echo "ğŸ”— GHCR: ${{ env.GHCR_REGISTRY }}/${{ env.GITHUB_OWNER }}"