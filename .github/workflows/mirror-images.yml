# https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions
name: Mirror Docker Images

env:
  GITHUB_OWNER: freemankevin
  GHCR_REGISTRY: ghcr.io
  IMAGES_MANIFEST: images-manifest.yml

on:
  schedule:
    - cron: '30 1 * * *'
  push:
    branches-ignore:
      - 'dependabot/**'
    tags-ignore:
      - '**'
    paths:
      - 'images-manifest.yml'
      - '.github/workflows/mirror-images.yml'
  pull_request:
    paths:
      - 'images-manifest.yml'
      - '.github/workflows/mirror-images.yml'
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  mirror-docker-images:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    permissions:
      packages: write
      contents: write

    concurrency:
      group: ${{ github.workflow }}
      cancel-in-progress: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip jq
          pip3 install pyyaml requests

      - name: Install regclient
        uses: iarekylew00t/regctl-installer@v4

      - name: Login to docker.io
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Login to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GHCR_REGISTRY }}
          username: ${{ env.GITHUB_OWNER }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Update manifest with latest versions
        id: update_manifest
        run: |
          set -euo pipefail
          
          python3 << 'PYTHON_SCRIPT'
          import yaml
          import re
          import requests
          from pathlib import Path
          from datetime import datetime, timezone

          def version_key(version_str):
              """ËΩ¨Êç¢ÁâàÊú¨Âè∑‰∏∫ÂèØÊØîËæÉÁöÑÂÖÉÁªÑ"""
              try:
                  if not version_str:
                      return (0, 0, 0)
                  
                  # Â§ÑÁêÜ RELEASE Ê†ºÂºè
                  if version_str.startswith('RELEASE.'):
                      date_match = re.search(r'(\d{4})-(\d{2})-(\d{2})', version_str)
                      if date_match:
                          return tuple(map(int, date_match.groups()))
                  
                  # ÁßªÈô§ v ÂâçÁºÄ
                  if version_str.startswith('v'):
                      version_str = version_str[1:]
                  
                  # ÂàÜÂâ≤ÁâàÊú¨Âè∑ÔºàÁßªÈô§ÂêéÁºÄÔºâ
                  version_parts = version_str.split('-')[0]
                  parts = []
                  for part in version_parts.split('.'):
                      try:
                          parts.append(int(part))
                      except ValueError:
                          parts.append(0)
                  
                  while len(parts) < 3:
                      parts.append(0)
                  
                  return tuple(parts[:3])
              except:
                  return (0, 0, 0)

          def get_latest_tag(repository, tag_pattern, exclude_pattern=None):
              """‰ªé Docker Hub Ëé∑ÂèñÁ¨¶ÂêàÊ®°ÂºèÁöÑÊúÄÊñ∞Ê†áÁ≠æ"""
              try:
                  url = f"https://registry.hub.docker.com/v2/repositories/{repository}/tags"
                  params = {'page_size': 100, 'ordering': 'last_updated'}
                  
                  response = requests.get(url, params=params, timeout=30)
                  if response.status_code != 200:
                      print(f"‚ö†Ô∏è  Failed to fetch tags for {repository}")
                      return None
                  
                  data = response.json()
                  results = data.get('results', [])
                  
                  if not results:
                      return None
                  
                  matching_tags = []
                  for tag in results:
                      tag_name = tag['name']
                      
                      # ÂåπÈÖç tag_pattern
                      if not re.match(tag_pattern, tag_name):
                          continue
                      
                      # ÊéíÈô§ exclude_pattern
                      if exclude_pattern and re.match(exclude_pattern, tag_name):
                          continue
                      
                      matching_tags.append(tag_name)
                  
                  if not matching_tags:
                      return None
                  
                  # ÊéíÂ∫èÂπ∂ËøîÂõûÊúÄÊñ∞ÁâàÊú¨
                  matching_tags.sort(key=version_key)
                  return matching_tags[-1]
                  
              except Exception as e:
                  print(f"‚ùå Error fetching tags for {repository}: {str(e)}")
                  return None

          # ËØªÂèñÊ∏ÖÂçï
          manifest_file = Path('images-manifest.yml')
          with open(manifest_file, 'r') as f:
              manifest = yaml.safe_load(f)

          print("üîÑ ÂºÄÂßãÊõ¥Êñ∞ÈïúÂÉèÁâàÊú¨...")
          updated_count = 0

          for img in manifest.get('images', []):
              if not img.get('enabled', True):
                  continue
              
              source = img['source']
              parts = source.split(':')
              
              if len(parts) != 2:
                  continue
              
              repository = parts[0]
              current_version = parts[1]
              tag_pattern = img.get('tag_pattern')
              exclude_pattern = img.get('exclude_pattern')
              
              if not tag_pattern:
                  print(f"‚ö†Ô∏è  Skipping {repository}: no tag_pattern defined")
                  continue
              
              print(f"üîç Checking {repository}...")
              
              latest_tag = get_latest_tag(repository, tag_pattern, exclude_pattern)
              
              if latest_tag:
                  new_source = f"{repository}:{latest_tag}"
                  if source != new_source:
                      print(f"  ‚úÖ Updated: {current_version} -> {latest_tag}")
                      img['source'] = new_source
                      updated_count += 1
                  else:
                      print(f"  ‚ÑπÔ∏è  Already latest: {latest_tag}")
              else:
                  print(f"  ‚ö†Ô∏è  Could not find matching version")

          # ‰øùÂ≠òÊõ¥Êñ∞ÂêéÁöÑÊ∏ÖÂçï
          with open(manifest_file, 'w') as f:
              yaml.dump(manifest, f, allow_unicode=True, default_flow_style=False, sort_keys=False)

          print(f"\n‚úÖ Updated {updated_count} images")
          
          # ‰ΩøÁî®Êñ∞ÁöÑ GitHub Actions ËæìÂá∫ÊñπÂºè
          with open('$GITHUB_OUTPUT', 'a') as f:
              f.write(f"updated_count={updated_count}\n")
          PYTHON_SCRIPT

      - name: Commit manifest changes
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add images-manifest.yml
          
          if git diff --staged --quiet; then
            echo "üìù No manifest changes to commit"
          else
            git commit -m "chore: update image versions in manifest [skip ci]"
            echo "‚úÖ Manifest changes committed"
          fi

      - name: Mirror images
        id: mirror
        run: |
          set -euo pipefail
          
          python3 << 'PYTHON_SCRIPT'
          import yaml
          import json
          import subprocess
          import sys
          from datetime import datetime, timezone
          from pathlib import Path

          def mirror_image(source, target):
              """ÈïúÂÉèÂêåÊ≠•"""
              try:
                  cmd = [
                      'regctl', 'image', 'copy',
                      '--verbosity', 'info',
                      '--digest-tags',
                      '--include-external',
                      '--referrers',
                      source, target
                  ]
                  result = subprocess.run(cmd, capture_output=True, text=True, timeout=300)
                  return result.returncode == 0
              except Exception as e:
                  print(f"‚ùå Mirror failed: {str(e)}", file=sys.stderr)
                  return False

          # ËØªÂèñÊ∏ÖÂçï
          with open('images-manifest.yml', 'r') as f:
              manifest = yaml.safe_load(f)

          registry = "${{ env.GHCR_REGISTRY }}"
          owner = "${{ env.GITHUB_OWNER }}"
          
          mirrored_images = []
          success_count = 0
          fail_count = 0

          for img in manifest.get('images', []):
              if not img.get('enabled', True):
                  continue
              
              source = img['source']
              description = img.get('description', '')
              
              # ÊèêÂèñÈïúÂÉèÂêçÂíåÁâàÊú¨
              image_name = source.split(':')[0]
              version = source.split(':')[1] if ':' in source else 'latest'
              
              print(f"üîç Processing {source}...")
              
              # ÊûÑÂª∫ÁõÆÊ†áÈïúÂÉè
              repo_name = image_name.replace('/', '__')
              target_image = f"{registry}/{owner}/{repo_name}:{version}"
              
              print(f"üì¶ Source: {source}")
              print(f"üéØ Target: {target_image}")
              
              # ÊâßË°åÈïúÂÉèÂêåÊ≠•
              if mirror_image(source, target_image):
                  print(f"‚úÖ Successfully mirrored {source}")
                  mirrored_images.append({
                      'name': image_name,
                      'source': source,
                      'target': target_image,
                      'version': version,
                      'description': description,
                      'repository': repo_name,
                      'synced_at': datetime.now(timezone.utc).isoformat()
                  })
                  success_count += 1
              else:
                  print(f"‚ùå Failed to mirror {source}")
                  fail_count += 1

          # ÁîüÊàêÈïúÂÉèÊ∏ÖÂçï JSON
          output_data = {
              'updated_at': datetime.now(timezone.utc).isoformat(),
              'registry': registry,
              'owner': owner,
              'total_count': len(mirrored_images),
              'success_count': success_count,
              'fail_count': fail_count,
              'images': mirrored_images
          }

          # Á°Æ‰øùÁõÆÂΩïÂ≠òÂú®
          Path('web/public').mkdir(parents=True, exist_ok=True)
          
          # ÂÜôÂÖ• JSON Êñá‰ª∂
          with open('web/public/images.json', 'w') as f:
              json.dump(output_data, f, indent=2, ensure_ascii=False)

          print(f"\nüìä Summary:")
          print(f"   Total: {len(mirrored_images)}")
          print(f"   Success: {success_count}")
          print(f"   Failed: {fail_count}")
          print(f"‚úÖ Generated images.json")
          
          # ‰ΩøÁî®Êñ∞ÁöÑ GitHub Actions ËæìÂá∫ÊñπÂºè
          with open('$GITHUB_OUTPUT', 'a') as f:
              f.write(f"success_count={success_count}\n")
              f.write(f"fail_count={fail_count}\n")
          PYTHON_SCRIPT

      - name: Commit and push all changes
        if: success()
        run: |
          git add web/public/images.json
          
          if git diff --staged --quiet && git diff --quiet; then
            echo "üìù No changes to commit"
          else
            if ! git diff --staged --quiet; then
              git commit -m "chore: update images manifest [skip ci]"
            fi
            git push
            echo "‚úÖ Changes committed and pushed"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## üéâ Mirror Sync Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- üïê Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- üîÑ Manifest Updated: ${{ steps.update_manifest.outputs.updated_count }} images" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Successfully Synced: ${{ steps.mirror.outputs.success_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ùå Failed: ${{ steps.mirror.outputs.fail_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- üîó Registry: ${{ env.GHCR_REGISTRY }}/${{ env.GITHUB_OWNER }}" >> $GITHUB_STEP_SUMMARY