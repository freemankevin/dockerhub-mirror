# https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions
name: Keep Workflows Alive

env:
  GITHUB_OWNER: freemankevin

on:
  schedule:
    # æ¯æœˆ 1 å· UTC 00:00 è¿è¡Œ
    - cron: '0 0 1 * *'
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  keep-workflows-alive:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Keep Workflows alive
        run: |
          set -euxo pipefail

          echo "ğŸ”„ Starting workflow keep-alive process..."
          echo "ğŸ“¦ Repository: ${{ github.repository }}"
          echo "ğŸ‘¤ Owner: ${{ env.GITHUB_OWNER }}"

          workflow_api_url="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@api.github.com/repos/${{ github.repository }}/actions/workflows"

          # è·å–æ‰€æœ‰å·¥ä½œæµ
          workflows=$(curl -sSf \
            -H "Accept: application/vnd.github.v3+json" \
            "$workflow_api_url" | \
            jq '.workflows[] | select(.state=="disabled") | {id: .id, name: .name}' -r)

          if [[ -z "$workflows" ]]; then
            echo "âœ… All workflows are already enabled!"
            exit 0
          fi

          # éå†ç¦ç”¨çš„å·¥ä½œæµå¹¶å¯ç”¨
          while IFS= read -r line; do
            if [[ -z "$line" ]]; then
              continue
            fi

            # è§£æ JSON æ ¼å¼çš„è¾“å‡º
            workflow_id=$(echo "$line" | jq -r '.id')
            workflow_name=$(echo "$line" | jq -r '.name')

            if [[ -n "$workflow_id" && -n "$workflow_name" ]]; then
              echo "::group::ğŸ”“ Enabling [$workflow_name] (ID: $workflow_id)..."

              response=$(curl -sS -X PUT \
                -H "Accept: application/vnd.github.v3+json" \
                "$workflow_api_url/$workflow_id/enable" \
                -w "\n%{http_code}")

              http_code=$(echo "$response" | tail -n 1)

              if [[ "$http_code" == "204" || "$http_code" == "200" ]]; then
                echo "âœ… Successfully enabled: $workflow_name"
              else
                echo "âš ï¸ Response code: $http_code"
              fi

              echo "::endgroup::"
            fi
          done <<< "$(curl -sSf \
            -H "Accept: application/vnd.github.v3+json" \
            "$workflow_api_url" | \
            jq '.workflows[] | select(.state=="disabled")')"

          echo "âœ¨ Workflow keep-alive process completed!"